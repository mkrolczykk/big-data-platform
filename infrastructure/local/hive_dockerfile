FROM apache/hive:3.1.3

# Zainstaluj narzędzia sieciowe (nc, wget)
USER root
RUN apt-get update && apt-get install -y netcat-openbsd net-tools wget && apt-get clean

# Pobierz i zainstaluj driver MySQL
RUN wget -q -O /tmp/mysql-connector-j-8.0.33.tar.gz \
    https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-j-8.0.33.tar.gz && \
    tar -xzf /tmp/mysql-connector-j-8.0.33.tar.gz -C /tmp && \
    cp /tmp/mysql-connector-j-8.0.33/mysql-connector-j-8.0.33.jar /opt/hive/lib/ && \
    rm -rf /tmp/mysql-connector-j-8.0.33* && \
    echo "MySQL driver installed successfully"

# Pobierz i zainstaluj biblioteki AWS S3 dla Hadoop
RUN wget -q -O /opt/hive/lib/hadoop-aws-3.2.0.jar \
    https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-aws/3.2.0/hadoop-aws-3.2.0.jar && \
    wget -q -O /opt/hive/lib/aws-java-sdk-bundle-1.11.375.jar \
    https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-bundle/1.11.375/aws-java-sdk-bundle-1.11.375.jar

# Sprawdź czy biblioteki zostały poprawnie zainstalowane
RUN ls -la /opt/hive/lib/mysql-connector-j-8.0.33.jar && \
    ls -la /opt/hive/lib/hadoop-aws-3.2.0.jar && \
    ls -la /opt/hive/lib/aws-java-sdk-bundle-1.11.375.jar

# Utwórz katalog .beeline dla użytkownika hive
RUN mkdir -p /home/hive/.beeline && chown hive:hive /home/hive/.beeline

# Utwórz skrypt inicjalizacyjny
COPY ./trino/scripts/init-hive.sh /scripts/init-hive.sh
RUN chmod +x /scripts/init-hive.sh

ENTRYPOINT ["/scripts/init-hive.sh"]

USER hive